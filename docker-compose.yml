version: "3.7"
services:

## --------------------------- BACKEND API (Manager) --------------------------- ##
  backend_api:
    image: ghcr.io/tedrob31/catalogo-web-googledrive:manager
    build: 
      context: .
      dockerfile: Dockerfile
      target: manager
    networks:
      - r4tlabsnet
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      # ADMIN CREDENTIALS (Load from environment)
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-change_me_please}
      # GOOGLE DRIVE CREDENTIALS
      - GOOGLE_APPLICATION_CREDENTIALS=/app/cache/credentials.json
      # Cloudflare Cache Purge (Optional)
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      # Domain for Metadata (SSG)
      - NEXT_PUBLIC_DOMAIN_NAME=${DOMAIN_NAME:-r4tlabs.com}
      # Performance Tuning
      - NODE_OPTIONS='--max-old-space-size=2048'
    volumes:
      - catalog_cache:/app/cache
      - catalog_images:/app/public/images
      - catalog_out:/app/out
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2.0"
          memory: 2048M
      labels:
        - traefik.enable=true
        - traefik.docker.network=r4tlabsnet
        
        # Router unificado para todo el tráfico de la web (Next.js maneja frontend y API con ISR)
        - "traefik.http.routers.r4t-backend.rule=(Host(`${DOMAIN_NAME:-r4tlabs.com}`) || Host(`www.${DOMAIN_NAME:-r4tlabs.com}`))"
        - "traefik.http.routers.r4t-backend.priority=50000"
        - "traefik.http.routers.r4t-backend.entrypoints=websecure"
        - "traefik.http.routers.r4t-backend.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.r4t-backend.service=backend_api"
        - "traefik.http.services.backend_api.loadbalancer.server.port=3000"

## --------------------------- STATIC SERVER (Nginx) --------------------------- ##
  static_server:
    image: nginx:alpine
    networks:
      - r4tlabsnet
    volumes:
      - catalog_images:/usr/share/nginx/html/images:ro
      - catalog_out:/usr/share/nginx/html
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
    deploy:
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1.0"
          memory: 128M
      labels:
        - traefik.enable=true
        - traefik.docker.network=r4tlabsnet
        
        # REGLA ESTÁTICA EXCLUSIVA: Nginx solo sirve la carpeta /images/ para descargas directas puras
        - "traefik.http.routers.r4t-static.rule=(Host(`${DOMAIN_NAME:-r4tlabs.com}`) || Host(`www.${DOMAIN_NAME:-r4tlabs.com}`)) && PathPrefix(`/images`)"
        - "traefik.http.routers.r4t-static.priority=60000" # Prioridad mayor al frontend general
        - "traefik.http.routers.r4t-static.entrypoints=websecure"
        - "traefik.http.routers.r4t-static.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.r4t-static.service=static_server"
        - "traefik.http.services.static_server.loadbalancer.server.port=80"

## --------------------------- VOLUMES & NETWORKS --------------------------- ##

volumes:
  catalog_cache:
    name: catalog_cache
  catalog_images:
    name: catalog_images
  catalog_out:
    name: catalog_out

networks:
  r4tlabsnet:
    external: true
    name: r4tlabsnet

configs:
  nginx_conf:
    file: ./nginx/nginx.conf
