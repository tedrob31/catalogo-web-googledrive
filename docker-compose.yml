version: "3.7"
services:

## --------------------------- BACKEND API (Manager) --------------------------- ##
  backend_api:
    image: ghcr.io/tedrob31/catalogo-web-googledrive:manager
    build: 
      context: .
      dockerfile: Dockerfile
      target: manager
    networks:
      - r4tlabsnet
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      # ADMIN CREDENTIALS (REPLACE WITH SECURE VALUES OR SECRETS)
      - ADMIN_USER=admin
      - ADMIN_PASS=R4tlabs1234_
      # GOOGLE DRIVE CREDENTIALS
      - GOOGLE_APPLICATION_CREDENTIALS=/app/cache/credentials.json
      # Performance Tuning
      - NODE_OPTIONS='--max-old-space-size=2048'
    volumes:
      - catalog_cache:/app/cache
      - catalog_images:/app/public/images
      - catalog_out:/app/out
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2.0"
          memory: 2048M
      labels:
        - traefik.enable=true
        - traefik.docker.network=r4tlabsnet
        
        # Router 1: API
        - traefik.http.routers.backend_api.rule=(Host(`r4tlabs.com`)||Host(`www.r4tlabs.com`)) && PathPrefix(`/api`)
        - traefik.http.routers.backend_api.entrypoints=websecure
        - traefik.http.routers.backend_api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.backend_api.priority=10000
        - traefik.http.routers.backend_api.service=backend_api
        - traefik.http.routers.backend_api.middlewares=compress,sslheader

        # Router 2: Admin
        - traefik.http.routers.backend_admin.rule=(Host(`r4tlabs.com`)||Host(`www.r4tlabs.com`)) && PathPrefix(`/modaadmin`)
        - traefik.http.routers.backend_admin.entrypoints=websecure
        - traefik.http.routers.backend_admin.tls.certresolver=letsencryptresolver
        - traefik.http.routers.backend_admin.priority=10000
        - traefik.http.routers.backend_admin.service=backend_api
        - traefik.http.routers.backend_admin.middlewares=compress,sslheader

        # Router 3: Assets (_next)
        - traefik.http.routers.backend_assets.rule=(Host(`r4tlabs.com`)||Host(`www.r4tlabs.com`)) && PathPrefix(`/_next`)
        - traefik.http.routers.backend_assets.entrypoints=websecure
        - traefik.http.routers.backend_assets.tls.certresolver=letsencryptresolver
        - traefik.http.routers.backend_assets.priority=10000
        - traefik.http.routers.backend_assets.service=backend_api
        - traefik.http.routers.backend_assets.middlewares=compress,sslheader

        # Service Definition
        - traefik.http.services.backend_api.loadbalancer.server.port=3000
        - traefik.http.services.backend_api.loadbalancer.passHostHeader=true
        - traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https

## --------------------------- STATIC SERVER (Nginx) --------------------------- ##
  static_server:
    image: nginx:alpine
    networks:
      - r4tlabsnet
    volumes:
      - catalog_images:/usr/share/nginx/html/images:ro
      - catalog_out:/usr/share/nginx/html
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
    deploy:
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1.0"
          memory: 128M
      labels:
        - traefik.enable=true
        - traefik.docker.network=r4tlabsnet
        # Catch-all route for static files
        - traefik.http.routers.static_server.rule=Host(`r4tlabs.com`)||Host(`www.r4tlabs.com`)
        - traefik.http.routers.static_server.entrypoints=websecure
        - traefik.http.routers.static_server.tls.certresolver=letsencryptresolver
        - traefik.http.routers.static_server.priority=100
        - traefik.http.routers.static_server.service=static_server
        - traefik.http.services.static_server.loadbalancer.server.port=80

## --------------------------- VOLUMES & NETWORKS --------------------------- ##

volumes:
  catalog_cache:
    name: catalog_cache
  catalog_images:
    name: catalog_images
  catalog_out:
    name: catalog_out

networks:
  r4tlabsnet:
    external: true
    name: r4tlabsnet

configs:
  nginx_conf:
    file: ./nginx/nginx.conf
