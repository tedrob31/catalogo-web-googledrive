events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # High Performance Tuning
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    
    # Compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    
    # Cache Control
    map $sent_http_content_type $expires {
        default                    off;
        text/html                  epoch;
        text/css                   max;
        application/javascript     max;
        ~image/                    max; # Cache images aggressively (1 year)
    }

    server {
        listen 80;
        server_name localhost;

        # The root is where we mount the volume
        # We mount 'catalog_images' to /usr/share/nginx/html/images
        root /usr/share/nginx/html;

        # Serve /images requests
        location /images/ {
            # Use root directive: request /images/foo.webp looks in /usr/share/nginx/html/images/foo.webp
            # Expires headers for aggressive caching
            expires $expires;
            add_header Cache-Control "public, no-transform";
            
            # CORS (Optional, but good for CDN/External use)
            add_header Access-Control-Allow-Origin *;
        }

        # Health Check
        location /health {
            return 200 'healthy';
            add_header Content-Type text/plain;
        }
    }
}
